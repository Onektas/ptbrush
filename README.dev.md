


### 整体架构

1. PT站种子抓取

    定时从PT站获取Free的种子，并进行保存。等待之后的刷流使用

2. qbittorrent信息记录
   
    定时记录qbittorrent中所有由本工具提交的种子的信息，包括瞬时下载速度、瞬时上传速度、以及累计的下载总量，上传总量。

    定时记录qbittorrent本身的状态，包括下载速度、上传速度、正在下载的种子数量、正在做种的种子数量、正在做种的种子列表、正在下载的种子列表。

3. 刷流

    基于刷流逻辑，对qbittorrent进行新增、删除刷流任务的操作。

    1. 新增
    
        在决定往下载器中添加种子时要求同时满足多个条件：
        
        | 序号 | 条件                                                         | 解释                                                         |
        | ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
        | 1    | 下载器中的未完成的种子个数小于`max_downloading_torrents`     | 同时进行下载的刷流种子数过多，会导致上传速度一直提不上来。因此最好是限制一下同时下载的种子数 |
        | 2    | 下载器在一个时间周期内(`download_cycle`)的最大下载速度小于`expect_download_speed` | 经过我测试qb在高速下载时原本有上传速度的种子会受到影响，上传速度会降低。因此需要等下载器中无高速下载任务时，在进行其他条件判定是否需要新增刷流任务 |
        | 3    | 下载器在一个时间周期内(`upload_cycle`)的平均上传速度小于`expect_upload_speed` | 在一个段时间内，下载器中的正在做种的种子，持续没有上传速度，才新增刷流任务。如果下载器在一段时间内平均上传速度是达标的，此时新增下载任务，可能会影响正在做种的任务，降低其上传速度 |
        | 4    | 当前下载器默认路径下剩余空间大于阈值`min_disk_space`         | 避免刷流任务把磁盘空间用尽                                   |
        
    2. 删除
    
        删除刷流任务的逻辑比较简单，只有一种情况
    
        * 下载器中正在下载的种子临近Free结束时间，默认为1小时，暂不支持修改。



### 种子下载逻辑

PT站中Free的种子，有可能会出现某个种子文件特别大的情况，俗称大包，这类种子，在刷流时可以只下载种子中的部分文件快速下载完进入做种状态，如果全部文件都下载的情况下，QB在高速下载时上传速度会变慢。

`ptbrush`在新增了种子之后，会定时检查下载器中种子文件大小超过阈值的种子，并对种子进行瘦身操作，将种子中的部分文件设置为不下载，直到种子文件大小在一个合理的范围内。





